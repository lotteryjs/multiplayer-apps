# æ¢ç´¢åŸºäº Golang åˆ†å¸ƒå¼åº”ç”¨

### Blockchain
[blockchain-tutorial](https://liuchengxu.gitbook.io/blockchain)

### ç›®æ ‡ï¼šç”¨ Go æŠ˜è…¾ä¸ªå¯ç”¨äºç”Ÿäº§çš„å®æ—¶åº”ç”¨(ã‚œ-ã‚œ)ã¤ãƒ­ å¹²æ¯~ğŸ¤£
* [æœ¬ç¬”è®°ğŸ“’é˜…è¯»å‰ç½®çŸ¥è¯†](#æœ¬ç¬”è®°é˜…è¯»å‰ç½®çŸ¥è¯†)
* [å¿«é€Ÿä¸Šæ‰‹ GO ä¸ WebSocket](#å¿«é€Ÿä¸Šæ‰‹-GO-ä¸-WebSocket)
* [Nano åŸºæœ¬æœ¯è¯­è„‘å›¾](#Nano-åŸºæœ¬æœ¯è¯­è„‘å›¾)
* [é€šè¿‡ starx-chat-demo å¿«é€Ÿä¸Šæ‰‹ Nano](#é€šè¿‡-starx-chat-demo-å¿«é€Ÿä¸Šæ‰‹-Nano)
* [Nano è·¯ç”±å‹ç¼©è„‘å›¾](#Nano-è·¯ç”±å‹ç¼©è„‘å›¾)
* [Nano é€šä¿¡åè®®è„‘å›¾](#Nano-é€šä¿¡åè®®è„‘å›¾)
* [NanoServer æ¸¸æˆæœåŠ¡å™¨ä¸šåŠ¡åˆ†æ](#NanoServer-æ¸¸æˆæœåŠ¡å™¨ä¸šåŠ¡åˆ†æ)
* [Nano åˆ†å¸ƒå¼ Chat Demo å¿«é€Ÿä¸Šæ‰‹](#Nano-åˆ†å¸ƒå¼-Chat-Demo-å¿«é€Ÿä¸Šæ‰‹)

æŠ€æœ¯
* ç”Ÿäº§å·¥å…·ï¼Œå°±åƒæ–§å­ã€é“²å­ä¸€æ ·
* å¼€å‘è¯­è¨€ã€æ¡†æ¶éƒ½æ˜¯æŠ€æœ¯ï¼ŒåŠªåŠªåŠ›å­¦ä¹ å¤§å¤šéƒ½å¯ä»¥æŒæ¡ã€

æ€æƒ³
* æ¥è‡ªäºå¸¸å¹´ç´¯æœˆå¯¹æŠ€æœ¯çš„ç§¯ç´¯å’Œç†è§£
* åˆç†çš„è®¾è®¡ã€æ¶æ„ç»éªŒã€æ¥è‡ªäºä¸æ–­çš„æŠ€æœ¯å®è·µå’Œæ€»ç»“

ç²¾ç¥
* ä¸å†å±€é™äºç‰¹å®šçš„æŠ€æœ¯ä½“ç³»ä¸æ€æƒ³ä½“ç³»
* å‡­å€Ÿç›´è§‰ï¼Œèƒ½å¤Ÿå¿«é€ŸæŠ“ä½é—®é¢˜çš„æœ¬è´¨ï¼Œåœ¨ä¼—å¤šçº·æ‰°ä¸­åšå‡ºæ­£ç¡®é€‰æ‹©

ç”»å›¾å·¥å…·
* [draw.io](https://www.draw.io/)
* [ç™¾åº¦è„‘å›¾](https://naotu.baidu.com/)

### æœ¬ç¬”è®°é˜…è¯»å‰ç½®çŸ¥è¯†

* æ„Ÿå…´è¶£å°±å¥½(ä¸æ‡‚çš„çŸ¥è¯† `Google` éƒ½ä¼šç»™ä½ ğŸ†™)
* åŸºæœ¬çš„æœåŠ¡ç«¯çŸ¥è¯†(æœ€å¥½æœ‰ Golang åŸºç¡€)
* æœ‰ Docker çŸ¥è¯†çš„è¯ï¼Œå‡ ä¹æ‰€æœ‰çš„å®éªŒç¯å¢ƒä½ éƒ½èƒ½å¿«é€Ÿçš„æ„é€ å‡ºæ¥

æœ¬ç³»åˆ—æ•™ç¨‹å°†ä»¥ [Nano](https://github.com/lonng/nano)(Lightweight, facility, high performance golang based game server framework) é¡¹ç›®ä¸ºæ¢ç´¢å¯¹è±¡ã€‚

* å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„é¡¹ç›®ï¼Œå¯ä»¥å¾ˆå¥½çš„è®©æˆ‘ä»¬å…¥é—¨ ` Golang é«˜å®æ—¶ Web åº”ç”¨`
* [Nano](https://github.com/lonng/nano) åº”ç”¨æ˜¯ç”±ä¸€äº›æ¾æ•£è€¦åˆçš„ Component ç»„æˆçš„ï¼Œæ¯ä¸ª Component å®Œæˆä¸€äº›åŠŸèƒ½ã€‚æ•´ä¸ªåº”ç”¨å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª Component å®¹å™¨ï¼Œå®Œæˆ Component çš„åŠ è½½ä»¥åŠç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
* React Component, Vue Component, Angular Component -> I love Component ğŸ¤£
* é‡é‡çº§ MMORPG æ¡†æ¶ç›®å‰ä¸åœ¨æ­¤è®¨è®ºèŒƒå›´å†…ğŸ¤£

å¯ç”¨äºå­¦ä¹ çš„ Server ç«¯é¡¹ç›®æºç 
  * [go-websocket](https://github.com/owenliang/go-websocket)
  * [go-push](https://github.com/owenliang/go-push)
  * [NanoServer](https://github.com/lonng/nanoserver)
  * å¤§å®¶ä¹Ÿå¯ä»¥ç›´æ¥çœ‹æºç å­¦ä¹ ï¼Œä¸ç”¨ç®¡æˆ‘ä¸‹é¢ğŸ‘‡çš„åºŸè¯ğŸ¤£ï¼ˆå¿«é€Ÿåº”ç”¨äºè‡ªå·±ä¸šåŠ¡çº¿æ‰æ˜¯æœ€é‡è¦çš„ï¼‰

ä¸ºä»€ä¹ˆé€‰æ‹© NanoServerï¼Ÿ

* å¾ˆå¤šé¡¹ç›®å¾ˆç¾ï¼Œä½†å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªåˆé€‚(å¤ªå¤§ or å¤ªå°)çš„ã€å®Œæ•´çš„ã€å¯åº”ç”¨äºç”Ÿäº§çš„çš„ä¸šåŠ¡ç¤ºä¾‹(ä¹Ÿè®¸æ˜¯æˆ‘æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ğŸ¤¦â€â™€ï¸)
* å®Œå®Œæ•´æ•´çš„äº†è§£äº†ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡å¹¶ç¼–ç ï¼Œå¯¹æˆ‘ä»¬å†å»å¼€å‘å…¶å®ƒå®æ—¶åº”ç”¨æ˜¯éå¸¸æœ‰å¸®åŠ©çš„

é’ˆå¯¹ Apk åç¼–è¯‘(`ç¬”è€…ç›®å‰å¯¹ apk é‡Œé¢ .luac æ–‡ä»¶å¹¶æ²¡æœ‰è§£å¯†ğŸ¤¦â€â™€ï¸`)ï¼š
* ~~[Androidé€†å‘ç ´è§£ï¼šAndroid Killerä½¿ç”¨](https://www.jianshu.com/p/61a93a6c0c1b)~~
* ~~[[Android Tools] AndroidKillerå®‰è£…ã€è®¾ç½®åŠä½¿ç”¨æ•™ç¨‹4æœˆ15æ—¥ç½‘ç›˜æ–‡ä»¶æœ‰æ›´æ–°(2019.6.21æ›´æ–°ä¸‹è½½åœ°å€)](https://www.52pojie.cn/forum.php?mod=viewthread&tid=726176&page=1)~~
* ~~[è¾“å…¥Javacæç¤ºä¸æ˜¯å†…éƒ¨æˆ–å¤–éƒ¨å‘½ä»¤](https://jingyan.baidu.com/article/08b6a591bdb18314a80922a0.html)~~
* ~~[cocos-luac æ¸¸æˆé€†å‘ç ´è§£åç¼–è¯‘çš„ä¸€äº›å¯ç¤º](https://segmentfault.com/a/1190000018100386)ï¼Œç„¶å¹¶åµğŸ¤¦â€â™€ï¸~~
* ~~æ¸¸æˆ `apk` æ‰€ä½¿ç”¨çš„é€šä¿¡åè®®ä¸æ˜¯ websocketï¼ŒO__O "â€¦ï¼Œä¼ è¾“çš„åŒ…ä¹Ÿæ˜¯åŠ è¿‡å¯†çš„ï¼Œæ‰€ä»¥ç”¨å·¥å…·æŠ“åŒ…â€¦â€¦hahahaha~ç„¶å¹¶åµğŸ¤¦â€â™€ï¸è¿˜æ˜¯ä¹–ä¹–çœ‹æœåŠ¡çš„æ—¥å¿—è¾“å‡ºå§ğŸ¤£~~
* ä¸è¿‡å‘¢ï¼Œè¿˜æ˜¯æ„Ÿè°¢ï¼Œæ„Ÿè°¢ï¼Œæ„Ÿè°¢ä½œè€…æä¾›å¦‚æ­¤ä¼˜ç§€çš„æœåŠ¡å™¨æºç 

ç”±äºå®¢æˆ·ç«¯å¹¶æ²¡æœ‰å¼€æºï¼ˆæ¯”è¾ƒè›‹ç–¼ğŸ¤¦â€â™€ï¸ï¼‰

* æƒ³æ³•1ï¼šæˆ‘è¿™è¾¹ä¼šé™†é™†ç»­ç»­ä½¿ç”¨ [Cocos Creator](https://www.cocos.com/creator) å»å¼€å‘ä¸€å¥—å®Œæ•´çš„å®¢æˆ·ç«¯å¹¶ä¸”å¼€æºã€‚
* æƒ³æ³•2ï¼šä½¿ç”¨ [redux](https://github.com/reduxjs/redux)(çŠ¶æ€ç®¡ç†) + [redux-saga](https://github.com/redux-saga/redux-saga)(æ¸¸æˆé€»è¾‘ç®¡ç†)

### å¿«é€Ÿä¸Šæ‰‹ GO ä¸ WebSocket

è§†é¢‘æ•™ç¨‹ï¼š[GOå®ç°åƒä¸‡çº§WebSocketæ¶ˆæ¯æ¨é€æœåŠ¡](https://www.imooc.com/learn/1025)
* éå¸¸å¥½çš„æ‰«ç›²æ•™ç¨‹
* å¦‚æœä½ ä»æ¥æ²¡æœ‰æ¥è§¦è¿‡ WebSocketï¼Œé‚£ä¹ˆä½ ä¸€å®šè¦çœ‹ä¸€ä¸‹

ç¤ºä¾‹æºç ï¼š[go-websocket](https://github.com/owenliang/go-websocket) & [go-push](https://github.com/owenliang/go-push)
* ä¸€äº› DevOps é¢å¤–è¯(ä¹Ÿè®¸ä½ ä¸éœ€è¦å…³æ³¨â€¦â€¦)
* å…³äºå¦‚ä½•ä¼˜é›…çš„éƒ¨ç½²(traffic,k8s,docker,swarmâ€¦â€¦è¯´å®è¯ç›¸å…³å†…å®¹è¿˜æŒºå¤šçš„ğŸ¤¦â€â™€ï¸)
* æœ¬åœ°å¯ä»¥é‡‡ç”¨ [Vagrant + VirtualBox] æˆ– [Docker Machine + VirtualBox] å¿«é€Ÿæ­å»ºå®éªŒç¯å¢ƒ,å¯ä»¥å‚çœ‹æˆ‘çš„[DevOps](https://github.com/Kirk-Wang/DevOps)ä»“åº“

ä»¥ä¸‹æ–‡å­—æ˜¯é’ˆå¯¹ä¸Šè¿°è§†é¢‘çš„è„±æ•å¤„ç†(`æ„Ÿè°¢å°é±¼å„¿å¤§ä½¬æä¾›å¦‚æ­¤é€šä¿—æ˜“æ‡‚çš„å…¥é—¨æ•™ç¨‹`)

#### ä»€ä¹ˆæ˜¯æ¨é€ç³»ç»Ÿï¼Ÿ

![push1](./images/go-websocket/push1.png)

#### å¼¹å¹•ç³»ç»Ÿçš„æŠ€æœ¯æŒ‘æˆ˜

æŠ€æœ¯å¤æ‚åº¦ï¼š

1 ä¸ªç›´æ’­é—´
* åœ¨çº¿äººæ•°ï¼š100ä¸‡
* å‘é€å¼¹å¹•ï¼š1000æ¡/ç§’
* æ¨é€é¢‘ç‡ï¼š100ä¸‡ * 1000æ¡/ç§’ = 10äº¿/ç§’

N ä¸ªç›´æ’­é—´
* æ¨é€é¢‘ç‡ï¼šN * 10äº¿/ç§’ (æœ‰ç‚¹å¯æ€•äº†ï¼Œæ€•è€æ¿é’±ä¸å¤ŸğŸ¤£â€¦â€¦)

#### æ‹‰æ¨¡å¼ä¸æ¨æ¨¡å¼çš„åŒºåˆ«

æ‹‰æ¨¡å¼
* æœåŠ¡ç«¯æ•°æ®æ›´æ–°é¢‘ç‡ä½ï¼Œåˆ™å¤§å¤šæ•°è¯·æ±‚æ˜¯æ— æ•ˆçš„
* åœ¨çº¿ç”¨æˆ·æ•°é‡å¤šï¼Œåˆ™æœåŠ¡ç«¯çš„æŸ¥è¯¢è´Ÿè½½é«˜
  * 100ä¸‡äººåŒæ—¶è½®è¯¢ï¼Œç›¸å½“äº DDOS æ”»å‡»äº†ï¼Œå¯¹æœåŠ¡ç«¯ä¸å¯æ¥å—
* å®šæ—¶è½®è¯¢æ‹‰å–ï¼Œæ— æ³•æ»¡è¶³æ—¶æ•ˆæ€§è¦æ±‚

æ¨æ¨¡å¼
* ä»…åœ¨æ•°æ®æ›´æ–°æ—¶æ‰éœ€è¦æ¨é€
* éœ€è¦ç»´æŠ¤å¤§é‡çš„åœ¨çº¿é•¿è¿æ¥
* æ•°æ®æ›´æ–°åå¯ä»¥ç«‹å³æ¨é€

åŸºäº WebSocket æ¨é€
* æµè§ˆå™¨æ”¯æŒçš„socketç¼–ç¨‹ï¼Œè½»æ¾ç»´æŒæœåŠ¡ç«¯çš„é•¿è¿æ¥
* åŸºäºTCPå¯é ä¼ è¾“ä¹‹ä¸Šçš„åè®®ï¼Œæ— éœ€å¼€å‘è€…å…³å¿ƒé€šè®¯ç»†èŠ‚
* æä¾›é«˜åº¦æŠ½è±¡çš„ç¼–ç¨‹æ¥å£ï¼Œä¸šåŠ¡å¼€å‘æˆæœ¬è¾ƒä½

#### WebSocket åè®®ä¸äº¤äº’(`å¿…å¤‡åŸºç¡€`)

![websocket](./images/go-websocket/websocket.png)

ä¼ è¾“åŸç†

* å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´é¦–å…ˆè¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ğŸ¤çš„æ“ä½œ
* æ¡æ‰‹æœ¬èº«æ˜¯åŸºäº HTTP è°ƒç”¨å®Œæˆçš„
* å®¢æˆ·ç«¯é¦–å…ˆå‘é€ä¸€æ¡ HTTP è¯·æ±‚åˆ°æœåŠ¡ç«¯
  * è¯·æ±‚çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œå®ƒ Header é‡Œé¢å¸¦äº†ä¸€ä¸ª `upgrade` å­—æ®µ
  * å®ƒå‘Šè¯‰æœåŠ¡ç«¯ï¼Œæˆ‘æƒ³è¦å‡çº§ä¸º WebSocket åè®®
* æœåŠ¡ç«¯æ”¶åˆ°ä¹‹åï¼Œå°±ä¼šå“åº”ä¸€ä¸ªæ¡æ‰‹ğŸ¤çš„ç¡®è®¤ `switching`
  * `switching` çš„æ„æ€å°±æ˜¯è¯´ï¼ŒæœåŠ¡ç«¯å·²ç»å…è®¸ä½ å‘ `websocket` åè®®è½¬æ¢äº†
* ä¸€æ—¦å®Œæˆåå•†å(å½“ç„¶ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„åº•å±‚ TCP è¿æ¥åº”è¯¥æ˜¯æ²¡æœ‰ä¸­æ–­çš„)
  * åè®®å‡çº§åï¼Œç»§ç»­å¤ç”¨ HTTP çš„åº•å±‚ Socket å®Œæˆåç»­é€šè®¯
  * å®é™…çš„ä¼ è¾“å•å…ƒæ˜¯ `message`
  * `websokcet` çš„ `message` æ˜¯æˆ‘ä»¬å®é™…ç¼–ç¨‹çš„ä¸€ä¸ªåŸºæœ¬å•ä½
    * ä½†å®é™…ä¸Šï¼Œ`message` åº•å±‚è¢«åˆ‡åˆ†ä¸ºå¤šä¸ª `frame` å¸§ä¼ è¾“
    * ç›®çš„æ˜¯ä»åè®®å±‚é¢ï¼Œå®ƒä¸èƒ½ä¼ è¾“ä¸€ä¸ªå¤§åŒ…ï¼Œå®ƒä¼šæŠŠå®ƒåˆ‡æˆä¸€ä¸ªä¸ªå°åŒ…åœ¨ç½‘ç»œä¸Šä¼ è¾“
    * ç¼–ç¨‹æ—¶åªéœ€æ“ä½œ `message`ï¼Œæ— éœ€å…³å¿ƒ frame
    * æ¡†æ¶åº•å±‚å®Œæˆ TCP ç½‘ç»œ I/Oï¼ŒWebSocket åè®®è§£æï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒ
* æ¥ä¸‹æ¥ï¼Œ`å®¢æˆ·ç«¯`å°±å¯ä»¥å‘`æœåŠ¡ç«¯`å‘é€åŸºäº`websocket`åè®®çš„ `message` (æ¶ˆæ¯)
* `æœåŠ¡ç«¯`ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘`å®¢æˆ·ç«¯`å‘é€åŸºäº`websocket`åè®®çš„ `message` (æ¶ˆæ¯)

#### æŠ“åŒ…è§‚å¯Ÿï¼Œå¼„æ¸…æ¥šæˆ‘ä»¬èƒ½åšæ¨é€çš„ä¾æ®(`éå¸¸é‡è¦`)
* ä½¿ç”¨ Chrome å¼€å‘è€…å·¥å…·ï¼Œè§‚å¯Ÿ WebSocket é€šè®¯æµç¨‹
  * ä»æ¡æ‰‹åˆ°åç»­æ¶ˆæ¯çš„æ”¶å‘ï¼Œåˆ°åº•ç»å†äº†ä»€ä¹ˆï¼Ÿ
* [go-websocket](https://github.com/owenliang/go-websocket)
  * Downä¸‹æ¥ï¼Œè‡ªå·±æ„Ÿå—ä¸€ä¸‹
  * åç»­ï¼Œæˆ‘ä¼šå¼„æˆä¸€ä¸ª Docker Image(ToDo)

![devtool-1](./images/go-websocket/devtool-1.png)

![devtool-2](./images/go-websocket/devtool-2.png)

#### æœåŠ¡ç«¯çš„æŠ€æœ¯é€‰å‹ä¸è€ƒè™‘

NodeJS
* æœ€å¸¸å¬åˆ°çš„åš websocket é€šè®¯ï¼Œæ¯”è¾ƒæ™®åŠ
  * websocket æœ¬èº«æ˜¯æµè§ˆå™¨ç«¯çš„ä¸€ç§ç¼–ç¨‹ï¼Œå‰ç«¯åŒå­¦åˆæ¯”è¾ƒæ“…é•¿ NodeJSï¼Œç½‘ä¸Šåˆæœ‰å¾ˆå¤šåšå®¢å»ä»‹ç»
* ä½†æ˜¯è¿™é‡Œé¢æœ‰ä¸ªé—®é¢˜
  * å•çº¿ç¨‹æ¨¡å‹(è™½ç„¶å®ƒèƒ½å¤šè¿›ç¨‹)ï¼Œæ¨é€æ€§èƒ½æœ‰é™
  * ä½†æ˜¯å¤šè¿›ç¨‹ä¸å¤ªé€‚åˆåšæ¨é€ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦éå†åœ¨çº¿ç”¨æˆ·é›†åˆ
  * å¤šè¿›ç¨‹è¿æ¥è¢«æ•£åˆ—åœ¨å¤šä¸ªè¿›ç¨‹ä¸Šï¼Œä¸æ”¾ä¾¿åš
  * æˆ‘ä»¬å¸Œæœ›è¿˜æ˜¯å¤šçº¿ç¨‹çš„æ¯”è¾ƒå¥½
* å®ƒæ˜¯è§£é‡Šæ€§è¯­è¨€

C/C++
* è½®å­å¤ªå°‘ï¼ˆå½“ç„¶ï¼Œå¦‚æœä½ æœ‰å¾ˆå¼ºçš„ C/C++ èƒŒæ™¯ï¼Œé‚£ä¹ˆå®ƒæ˜¯æœ€å¥½çš„ğŸ¤£ï¼‰
  * TCP é€šè®¯ã€WebSocket åè®®å®ç°æˆæœ¬é«˜

Go
* å¤šçº¿ç¨‹ï¼ŒåŸºäºåç¨‹æ¨¡å‹å¹¶å‘
  * å¯¹äºå¼€å‘äººå‘˜éå¸¸å‹å¥½ï¼Œèƒ½å¿«é€Ÿå†™å¥½å¤šçº¿ç¨‹ï¼Œé«˜å¹¶å‘çš„ç¨‹åº
  * ç¼–è¯‘æ€§è¯­è¨€ï¼Œæ„å‘³ç€å®ƒçš„è¿è¡Œé€Ÿåº¦å¹¶ä¸æ…¢
* æˆç†Ÿçš„ WebSocket æ ‡å‡†åº“ï¼Œæ— éœ€é€ è½®å­
  * æ»¡è¶³ç™¾ä¸‡ç”¨æˆ·æ¨é€çš„å¤„ç†
  * ä¹Ÿä¸éœ€è¦ç‰¹åˆ«å…³å¿ƒåè®®çš„ç»†èŠ‚
  * å¯ç›´æ¥è¿›å…¥åˆ°ä¸šåŠ¡ä¸­ï¼Œè¿™æ‰æ˜¯å¯¹æˆ‘ä»¬æœ€æœ‰ä»·å€¼çš„éƒ¨åˆ†

#### å®ç° HTTP æœåŠ¡ç«¯
* WebSocket æ˜¯ HTTP åè®® Upgrade è€Œæ¥
* ä½¿ç”¨ http æ ‡å‡†åº“å¿«é€Ÿå®ç°ç©ºæ¥å£ï¼š/ws
  * é…ç½®è·¯ç”±
  * ç›‘å¬æœåŠ¡

#### å®Œæˆ WebSocket æ¡æ‰‹
* ä½¿ç”¨ websocket.Upgrader å®Œæˆåè®®æ¡æ‰‹ï¼Œå¾—åˆ° WebSocket é•¿è¿æ¥
  * æ¡æ‰‹å…·ä½“æ“ä½œäº¤ç»™æ ‡å‡†åº“å»æ“ä½œ
    * upgrader := websocket.Upgrader{ CheckOrigin: func }
    * upgrader.Upgrade(w, r, nil)
* æ“ä½œ websocket api, è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯ï¼Œç„¶ååŸæ ·å‘é€å›å»

#### å°è£… WebSocket

ç¼ºä¹å·¥ç¨‹åŒ–çš„è®¾è®¡
* å…¶å®ƒä»£ç æ¨¡å—ï¼Œæ— æ³•ç›´æ¥æ“ä½œ WebSocket è¿æ¥
* WebSocket è¿æ¥éçº¿ç¨‹å®‰å…¨ï¼Œå¹¶å‘è¯»/å†™éœ€è¦åŒæ­¥æ‰‹æ®µ
  * ReadMessage & WriteMessage åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªä»£ç è°ƒç”¨

éšè—ç»†èŠ‚
* å°è£…Connectionç»“æ„ï¼Œéšè— WebSocket åº•å±‚è¿æ¥
* å°è£…Connectionçš„APIï¼Œæä¾› Send/Read/Close ç­‰çº¿ç¨‹å®‰å…¨æ¥å£
* è¿™é‡Œä¼šæœ‰ç¼–ç ä¸æ€è€ƒçš„è„‘å›¾(ToDo)

APIåŸç†
* SendMessage å°†æ¶ˆæ¯æŠ•é€’åˆ° out channel
* ReadMessage ä» in channel è¯»å–æ¶ˆæ¯
* channel æ˜¯çº¿ç¨‹å®‰å…¨çš„

å†…éƒ¨åŸç†
* å¯åŠ¨è¯»åç¨‹ï¼Œå¾ªç¯è¯»å–WebSocketï¼Œå°†æ¶ˆæ¯æŠ•é€’åˆ° in channel
* å¯åŠ¨å†™åç¨‹ï¼Œå¾ªç¯è¯»å– out channelï¼Œå°†æ¶ˆæ¯å†™ç»™WebSocket

#### åƒä¸‡çº§å¼¹å¹•ç³»ç»Ÿçš„æ¶æ„ç§˜å¯† 

åˆ†ææŠ€æœ¯éš¾ç‚¹ï¼š

3ä¸ªæ€§èƒ½ç“¶é¢ˆ
* å†…æ ¸ç“¶é¢ˆ
* é”ç“¶é¢ˆ
* CPUç“¶é¢ˆ

å†…æ ¸ç“¶é¢ˆ
* æ¨é€é‡å¤§ï¼š100ä¸‡åœ¨çº¿ * 10æ¡/ç§’ = 1000ä¸‡æ¡/ç§’
* linux å†…æ ¸å‘é€ TCP çš„æé™åŒ…é¢‘ â‰ˆ 100ä¸‡æ¡/ç§’

é”ç“¶é¢ˆ
* éœ€è¦ç»´æŠ¤åœ¨çº¿ç”¨æˆ·é›†åˆï¼ˆ100ä¸‡åœ¨çº¿ï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—å…¸ç»“æ„
* æ¨é€æ¶ˆæ¯å³éå†æ•´ä¸ªé›†åˆï¼Œé¡ºåºå‘é€æ¶ˆæ¯ï¼Œè€—æ—¶æé•¿
* æ¨é€æœŸé—´ï¼Œå®¢æˆ·ç«¯ä»æ—§æ­£å¸¸ä¸Š/ä¸‹çº¿ï¼Œæ‰€ä»¥é›†åˆéœ€è¦ä¸Šé”
  * ä¸Šé”æœŸé—´ï¼Œå®¢æˆ·ç«¯æ— æ³•æ­£å¸¸ä¸Š/ä¸‹çº¿é—®é¢˜(æ‹¿ä¸åˆ°é”)ï¼Ÿ

CPU ç“¶é¢ˆ
* æµè§ˆå™¨æœåŠ¡ç«¯é€šå¸¸é‡‡å– json æ ¼å¼é€šè®¯
* json ç¼–ç éå¸¸è€—è´¹ CPU èµ„æº
* å‘ 100 ä¸‡åœ¨çº¿æ¨é€ä¸€æ¬¡ï¼Œåˆ™éœ€100ä¸‡æ¬¡ json encode
  * å¹³æ—¶1000ï¼Œ2000 QPS å‹æ ¹æ„Ÿå—ä¸å‡ºæ¥

æŠ€æœ¯éš¾ç‚¹çš„è§£å†³æ–¹æ¡ˆ

å†…æ ¸ç“¶é¢ˆ-ä¼˜åŒ–åŸç†
* å‡å°‘ç½‘ç»œå°åŒ…çš„å‘é€
  * ç½‘ç»œå°åŒ…ï¼ˆå‡ ç™¾å­—èŠ‚çš„å°±ç®—æ˜¯ç½‘ç»œä¸Šçš„å°åŒ…ï¼‰
  * ç½‘ç»œå°åŒ…ï¼Œå¯¹å†…æ ¸ä»¥åŠç½‘ç»œä¸Šçš„ä¸­é—´è®¾å¤‡éƒ½ä¼šé€ æˆä¸€ä¸ªå¤„ç†çš„å‹åŠ›

å†…æ ¸ç“¶é¢ˆ-ä¼˜åŒ–æ–¹æ¡ˆ
* å°†åŒä¸€ç§’å†…çš„ N æ¡æ¶ˆæ¯ï¼Œåˆå¹¶æˆä¸€æ¡æ¶ˆæ¯
* åˆå¹¶åï¼Œæ¯ç§’æ¨é€çš„æ¬¡æ•°åªç­‰äºåœ¨çº¿è¿æ¥æ•°
  * 100ä¸‡åœ¨çº¿
    * 10æ¡/ç§’ --> å°† 10 æ¡åˆå¹¶æˆä¸€æ¡
    * 20æ¡/ç§’ --> å°† 20 æ¡åˆå¹¶æˆä¸€æ¡
  * è¿™æ ·åªéœ€è¦æ¨100ä¸‡æ¬¡

é”ç“¶é¢ˆ-ä¼˜åŒ–åŸç†
* å¤§æ‹†å°

é”ç“¶é¢ˆ-ä¼˜åŒ–æ–¹æ¡ˆ
* è¿æ¥æ‰“æ•£åˆ°å¤šä¸ªé›†åˆä¸­ï¼Œæ¯ä¸ªé›†åˆæœ‰è‡ªå·±çš„é”
* å¤šçº¿ç¨‹å¹¶å‘æ¨é€å¤šä¸ªé›†åˆï¼Œé¿å…é”ç«äº‰
  * æ¨é€çš„è¿æ¥çš„é›†åˆä¸åŒï¼Œæ²¡æœ‰é”çš„ç«äº‰å…³ç³»
* è¯»å†™é”å–ä»£äº’æ–¥é”ï¼Œå¤šä¸ªæ¨é€ä»»åŠ¡å¯ä»¥å¹¶å‘éå†ç›¸åŒçš„é›†åˆ
  * ç»™é›†åˆä¸Šçš„é”æ˜¯è¯»å†™é”
  * è¦å¹¶å‘æ¨é€ä¸¤æ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½å¯ä»¥åŠ åˆ°è¯»é”ï¼Œå®ƒä»¬åŒæ—¶éå†åŒæ ·çš„é›†åˆï¼ŒæŠŠå„è‡ªçš„æ¶ˆæ¯æ¨é€å‡ºå»

CPU-ä¼˜åŒ–åŸç†
* å‡å°‘é‡å¤è®¡ç®—

CPU-ä¼˜åŒ–æ–¹æ¡ˆ
* jsonç¼–ç å‰ç½®ï¼Œ1æ¬¡æ¶ˆæ¯ç¼–ç  + 100ä¸‡æ¬¡æ¨é€
* æ¶ˆæ¯åˆå¹¶å‰ç½®ï¼ŒNæ¡æ¶ˆæ¯åˆå¹¶ååªç¼–ç ä¸€æ¬¡

![å•æœºæ¶æ„](./images/go-websocket/single-arc.png)

åˆ†å¸ƒå¼æ¶æ„

å•æœºç“¶é¢ˆ
* ç»´æŠ¤æµ·é‡é•¿è¿æ¥ä¼šèŠ±è´¹ä¸å°‘å†…å­˜
* æ¶ˆæ¯æ¨é€é¡ºæ—¶ä¼šæ¶ˆè€—å¤§é‡çš„CPUèµ„æº
* æ¶ˆæ¯æ¨é€ç¬æ—¶å¸¦å®½é«˜è¾¾400~600MB(4-6Gbits)ï¼Œæ˜¯ä¸»è¦ç“¶é¢ˆï¼
  * ä¸€èˆ¬çš„æœåŠ¡å™¨ï¼Œå®ƒçš„ç½‘å¡åªèƒ½è·‘åˆ° 100 MB(ä¹Ÿå°±æ˜¯è¯´æ˜¯ä¸€ä¸ªåƒå…†ç½‘å¡)
  * å¦‚æœè¦è·‘åˆ°400~600MBï¼Œéœ€è¦ä¸‡å…†ç½‘å¡

æ‰€ä»¥ï¼Œä¸ºäº†æ‰©å±•ï¼Œæˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼æ¶æ„

æˆ‘ä»¬æŠŠåˆšåˆšå¼€å‘çš„è¿™ä¸ªç¨‹åºå«åšç½‘å…³

é¦–å…ˆï¼ŒæŠŠç½‘å…³åšæˆä¸€ä¸ªé›†ç¾¤
* éƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹
* å‰é¢åšäº†è´Ÿè½½å‡è¡¡åï¼Œå°±ä¼šæŠŠè¿æ¥æ‰“ç®—åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå°±å®Œæˆäº†ç½‘å…³å±‚çš„æ¨ªå‘æ‰©å±•
* é—®é¢˜æ˜¯ï¼Ÿå½“æˆ‘ä»¬æ¨é€ä¸€ä¸ªæ¶ˆæ¯å‡ºå»çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å“ªä¸€ä¸ªç›´æ’­é—´åœ¨å“ªä¸€ä¸ªç½‘å…³èŠ‚ç‚¹ä¸Š
  * æœ€ç®€å•çš„æ–¹å¼æ˜¯æŠŠæ¶ˆæ¯å¹¿æ’­ç»™æ‰€æœ‰çš„ç½‘å…³èŠ‚ç‚¹
  * éƒ½å»å„è‡ªå»åšåˆ¤æ–­ï¼Œå„è‡ªå»åšæ¨é€


![ç½‘å…³é›†ç¾¤æ¶æ„](./images/go-websocket/arc2.png)

æ‰€ä»¥è¿™é‡Œæ¶‰åŠä¸€ä¸ªå¾€ç½‘å…³å±‚çš„ä¸€ä¸ªå¹¿æ’­ï¼Œè°æ¥åšï¼Ÿé€»è¾‘é›†ç¾¤

é€»è¾‘é›†ç¾¤
* åŸºäº HTTP/2 åè®®å‘ gateway é›†ç¾¤åˆ†å‘æ¶ˆæ¯
  * HTTP/2 æ”¯æŒè¿æ¥å¤ç”¨ï¼Œç”¨ä½œ RPC æ€§èƒ½æ›´åŠ 
    * èƒ½åœ¨å•ä¸ªçš„é•¿è¿æ¥ä¸Šåšé«˜ååçš„è¯·æ±‚ï¼Œåº”ç­”å¤„ç†

* åŸºäº HTTP/1 åè®®å¯¹å¤–æä¾›æ¨é€ API
  * HTTP/1 æ›´åŠ æ™®åŠï¼Œå¯¹ä¸šåŠ¡æ–¹æ›´åŠ å‹å¥½
  * ä¸šåŠ¡æ–¹è°ƒç”¨æ¥å£ï¼Œå°±èƒ½æŠŠæ¶ˆæ¯æ¨é€å‡ºå»

æ•´ä½“æ¶æ„

![æ•´ä½“æ¶æ„](./images/go-websocket/arc3.png)

--------------------------------


### Nano åŸºæœ¬æœ¯è¯­è„‘å›¾
è„‘å›¾æ˜¯æ ¹æ® [å¦‚ä½•æ„å»ºä½ çš„ç¬¬ä¸€ä¸ªnanoåº”ç”¨](https://github.com/lonng/nano/blob/master/docs/get_started_zh_CN.md)(æ³¨æ„ä»”ç»†é˜…è¯»è¿™ç¯‡æ–‡ç« ) æ¥æ•´ç†çš„ã€‚

![nano-get-started](images/nano-get-started.png)

### é€šè¿‡ starx-chat-demo å¿«é€Ÿä¸Šæ‰‹ Nano

å¼€å‘è¦ç‚¹ï¼šå®šä¹‰ç»„ä»¶ï¼Œæ³¨å†Œç»„ä»¶ï¼Œå®‰è£…ç»„ä»¶

[starx-chat-demo](https://github.com/lonng/nano/tree/master/examples/demo/chat)

![everything_start_with_nano_listen](./images/everything_start_with_nano_listen.png)

#### ä¸šåŠ¡åˆ†æ

![chat-demo](./images/nano/chat-demo.png)

é€šè¿‡ [å¦‚ä½•æ„å»ºä½ çš„ç¬¬ä¸€ä¸ªnanoåº”ç”¨](https://github.com/lonng/nano/blob/master/docs/get_started_zh_CN.md) æˆ‘ä»¬çŸ¥é“ï¼š
> nano åº”ç”¨æ˜¯ç”±ä¸€äº›æ¾æ•£è€¦åˆçš„ Component ç»„æˆçš„ï¼Œæ¯ä¸ª Component å®Œæˆä¸€äº›åŠŸèƒ½ã€‚æ•´ä¸ªåº”ç”¨å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª Component å®¹å™¨ï¼Œå®Œæˆ Component çš„åŠ è½½ä»¥åŠç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚æ¯ä¸ª Component å¾€å¾€æœ‰ Initï¼ŒAfterInitï¼ŒBeforeShutdownï¼ŒShutdown ç­‰æ–¹æ³•ï¼Œç”¨æ¥å®Œæˆç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

ä¸¤ä¸ªåœºæ™¯ï¼š

A. ç”¨æˆ·åŠ å…¥æˆ¿é—´ï¼š
  1. ç»‘å®šç”¨æˆ·idåˆ°Session
  2. Session ä¸­ç»‘å®šå½“å‰æˆ¿é—´ï¼Œæ–¹ä¾¿ç”¨æˆ·æŸä¸€æ—¶åˆ»åœ¨å½“å‰æˆ¿é—´å†…å¹¿æ’­ğŸ“¢æ¶ˆæ¯
  3. æ¨é€æˆ¿é—´å†…çš„å…¶ä»–æˆå‘˜ (UID) åˆ°å½“å‰ç”¨æˆ·
  4. æˆ¿é—´å†…å¹¿æ’­å…¶å®ƒæˆå‘˜æœ‰æ–°ç”¨æˆ·åŠ å…¥
  5. å°†å½“å‰ç”¨æˆ· Session æ·»åŠ åˆ°æˆ¿é—´ Session ç®¡ç†è€… Group

B. ç”¨æˆ·å‘æ¶ˆæ¯ï¼š
  1. ç”¨æˆ·(Session)æ˜¯å¦å·²ç»åŠ å…¥æˆ¿é—´
  2. æ‹¿åˆ°ç”¨æˆ·æ‰€åœ¨çš„æˆ¿é—´ï¼Œå¹¿æ’­ğŸ“¢æ¶ˆæ¯

C. è¾“å…¥è¾“å‡ºæµé‡ç»Ÿè®¡

### Nano è·¯ç”±å‹ç¼©è„‘å›¾

æ³¨æ„é˜…è¯»ï¼š[è·¯ç”±å‹ç¼©](https://github.com/lonng/nano/blob/master/docs/route_compression_zh_CN.md)

![Nano è·¯ç”±å‹ç¼©è„‘å›¾](./images/nano/route-compress.png)

### Nano é€šä¿¡åè®®è„‘å›¾

[åè®®æ ¼å¼](https://github.com/lonng/nano/blob/master/docs/communication_protocol_zh_CN.md)

[pomelo åè®®æ ¼å¼](https://github.com/NetEase/pomelo/wiki/%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F)

ä¸¤è€…å®Œå…¨ä¸€æ ·ï¼ŒNano ä½œè€…åº”è¯¥æ˜¯ç›´æ¥ç”¨çš„ç½‘æ˜“ Pomelo çš„å®šä¹‰ğŸ¤£ğŸ¤¦â€â™€ï¸

![communication-protocol](./images/nano/communication-protocol.png)

### NanoServer æ¸¸æˆæœåŠ¡å™¨ä¸šåŠ¡åˆ†æ

`å¤æ‚çš„é€»è¾‘ä¸æŠ€æœ¯ä½¿ç”¨çš„å‰ææ˜¯ï¼šä½ éœ€è¦ä¸€ä¸ªå¤æ‚çš„ä¸šåŠ¡åœºæ™¯`

![nanoserver-1.png](./images/nanoserver-1.png)

![nano-server-client4.png](./images/nano-server-client4.png)

#### NanoServer ä¸šåŠ¡è¡¨ç»“æ„

**[TABLES](https://lotteryjs.github.io/golang-server-dev/nanoserver-tables.html)**

![tables](./images/nanoserver-tables.png)

#### Nano-åˆ†å¸ƒå¼-Chat-Demo-å¿«é€Ÿä¸Šæ‰‹

See: [The distributed chat demo](https://github.com/lonng/nano/tree/master/examples/cluster)

è·‘èµ·æ¥ï¼š

```sh
cd examples/cluster

go run main.go master
go run main.go chat --listen "127.0.0.1:34580"
go run main.go gate --listen "127.0.0.1:34570" --gate-address "127.0.0.1:34590"
```